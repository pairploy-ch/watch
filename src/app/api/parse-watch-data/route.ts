import { NextResponse } from 'next/server';

export const dynamic = 'force-dynamic';

// Reference to brand mapping (expand as needed)
const REFERENCE_BRAND_MAPPING: Record<string, string> = {
  // Patek Philippe
  '5236P': 'Patek Philippe',
  '5373P': 'Patek Philippe',
  '5990': 'Patek Philippe',
  '5990/1A': 'Patek Philippe',
  '142.055': 'Patek Philippe',
  '181.062': 'Patek Philippe',
  '182.086': 'Patek Philippe',
  '4910': 'Patek Philippe',
  '4910/1200a': 'Patek Philippe',
  '4947': 'Patek Philippe',
  '4947/1a-001': 'Patek Philippe',
  '4947r': 'Patek Philippe',
  '15510BC': 'Patek Philippe',
  '15551ST': 'Patek Philippe',
  '15212NB': 'Patek Philippe',
  
  // F.P.Journe
  'Resonance': 'F.P.Journe',
  'Octa': 'F.P.Journe',
  'Octa Automatique': 'F.P.Journe',
  'Octa UTC': 'F.P.Journe',
  'Octa Reserve': 'F.P.Journe',
  'Cqhronomtre Souverain': 'F.P.Journe',
  'Elegante': 'F.P.Journe',
  
  // Richard Mille
  'Rm65-01': 'Richard Mille',
  'Rm35-03': 'Richard Mille',
  
  // Rolex
  '116610LN': 'Rolex',
  '116610LV': 'Rolex',
  '116500LN': 'Rolex',
  '116500LN-0001': 'Rolex',
  '116500LN-0002': 'Rolex',
  '126610LN': 'Rolex',
  '126610LV': 'Rolex',
  '126500LN': 'Rolex',
  '126711CHNR': 'Rolex',
  '126715CHNR': 'Rolex',
  '126613LB': 'Rolex',
  '126613LN': 'Rolex',
  '126613LB-0002': 'Rolex',
  '126613LN-0001': 'Rolex',
  '126711CHNR-0002': 'Rolex',
  '126715CHNR-0001': 'Rolex',
  '126711CHNR-0003': 'Rolex',
  '126715CHNR-0002': 'Rolex',
  '126711CHNR-0004': 'Rolex',
  '126715CHNR-0003': 'Rolex',
  '126711CHNR-0005': 'Rolex',
  '126715CHNR-0004': 'Rolex',
  '126711CHNR-0006': 'Rolex',
  '126715CHNR-0005': 'Rolex',
  '126711CHNR-0007': 'Rolex',
  '126715CHNR-0006': 'Rolex',
  '126711CHNR-0008': 'Rolex',
  '126715CHNR-0007': 'Rolex',
  '126711CHNR-0009': 'Rolex',
  '126715CHNR-0008': 'Rolex',
  '126711CHNR-0010': 'Rolex',
  '126715CHNR-0009': 'Rolex',
  '126711CHNR-0011': 'Rolex',
  '126715CHNR-0010': 'Rolex',
  '126711CHNR-0012': 'Rolex',
  '126715CHNR-0011': 'Rolex',
  '126711CHNR-0013': 'Rolex',
  '126715CHNR-0012': 'Rolex',
  '126711CHNR-0014': 'Rolex',
  '126715CHNR-0013': 'Rolex',
  '126711CHNR-0015': 'Rolex',
  '126715CHNR-0014': 'Rolex',
  '126711CHNR-0016': 'Rolex',
  '126715CHNR-0015': 'Rolex',
  '126711CHNR-0017': 'Rolex',
  '126715CHNR-0016': 'Rolex',
  '126711CHNR-0018': 'Rolex',
  '126715CHNR-0017': 'Rolex',
  '126711CHNR-0019': 'Rolex',
  '126715CHNR-0018': 'Rolex',
  '126711CHNR-0020': 'Rolex',
  '126715CHNR-0019': 'Rolex',
  '126711CHNR-0021': 'Rolex',
  '126715CHNR-0020': 'Rolex',
  '126711CHNR-0022': 'Rolex',
  '126715CHNR-0021': 'Rolex',
  '126711CHNR-0023': 'Rolex',
  '126715CHNR-0022': 'Rolex',
  '126711CHNR-0024': 'Rolex',
  '126715CHNR-0023': 'Rolex',
  '126711CHNR-0025': 'Rolex',
  '126715CHNR-0024': 'Rolex',
  '126711CHNR-0026': 'Rolex',
  '126715CHNR-0025': 'Rolex',
  '126711CHNR-0027': 'Rolex',
  '126715CHNR-0026': 'Rolex',
  '126711CHNR-0028': 'Rolex',
  '126715CHNR-0027': 'Rolex',
  '126711CHNR-0029': 'Rolex',
  '126715CHNR-0028': 'Rolex',
  '126711CHNR-0030': 'Rolex',
  '126715CHNR-0029': 'Rolex',
  '126711CHNR-0031': 'Rolex',
  '126715CHNR-0030': 'Rolex',
  '126711CHNR-0032': 'Rolex',
  '126715CHNR-0031': 'Rolex',
  '126711CHNR-0033': 'Rolex',
  '126715CHNR-0032': 'Rolex',
  '126711CHNR-0034': 'Rolex',
  '126715CHNR-0033': 'Rolex',
  '126711CHNR-0035': 'Rolex',
  '126715CHNR-0034': 'Rolex',
  '126711CHNR-0036': 'Rolex',
  '126715CHNR-0035': 'Rolex',
  '126711CHNR-0037': 'Rolex',
  '126715CHNR-0036': 'Rolex',
  '126711CHNR-0038': 'Rolex',
  '126715CHNR-0037': 'Rolex',
  '126711CHNR-0039': 'Rolex',
  '126715CHNR-0038': 'Rolex',
  '126711CHNR-0040': 'Rolex',
  '126715CHNR-0039': 'Rolex',
  '126711CHNR-0041': 'Rolex',
  '126715CHNR-0040': 'Rolex',
  '126711CHNR-0042': 'Rolex',
  '126715CHNR-0041': 'Rolex',
  '126711CHNR-0043': 'Rolex',
  '126715CHNR-0042': 'Rolex',
  '126711CHNR-0044': 'Rolex',
  '126715CHNR-0043': 'Rolex',
  '126711CHNR-0045': 'Rolex',
  '126715CHNR-0044': 'Rolex',
  '126711CHNR-0046': 'Rolex',
  '126715CHNR-0045': 'Rolex',
  '126711CHNR-0047': 'Rolex',
  '126715CHNR-0046': 'Rolex',
  '126711CHNR-0048': 'Rolex',
  '126715CHNR-0047': 'Rolex',
  '126711CHNR-0049': 'Rolex',
  '126715CHNR-0048': 'Rolex',
  '126711CHNR-0050': 'Rolex',
  '126715CHNR-0049': 'Rolex',
  '126711CHNR-0051': 'Rolex',
  '126715CHNR-0050': 'Rolex',
  '126711CHNR-0052': 'Rolex',
  '126715CHNR-0051': 'Rolex',
  '126711CHNR-0053': 'Rolex',
  '126715CHNR-0052': 'Rolex',
  '126711CHNR-0054': 'Rolex',
  '126715CHNR-0053': 'Rolex',
  '126711CHNR-0055': 'Rolex',
  '126715CHNR-0054': 'Rolex',
  '126711CHNR-0056': 'Rolex',
  '126715CHNR-0055': 'Rolex',
  '126711CHNR-0057': 'Rolex',
  '126715CHNR-0056': 'Rolex',
  '126711CHNR-0058': 'Rolex',
  '126715CHNR-0057': 'Rolex',
  '126711CHNR-0059': 'Rolex',
  '126715CHNR-0058': 'Rolex',
  '126711CHNR-0060': 'Rolex',
  '126715CHNR-0059': 'Rolex',
  '126711CHNR-0061': 'Rolex',
  '126715CHNR-0060': 'Rolex',
  '126711CHNR-0062': 'Rolex',
  '126715CHNR-0061': 'Rolex',
  '126711CHNR-0063': 'Rolex',
  '126715CHNR-0062': 'Rolex',
  '126711CHNR-0064': 'Rolex',
  '126715CHNR-0063': 'Rolex',
  '126711CHNR-0065': 'Rolex',
  '126715CHNR-0064': 'Rolex',
  '126711CHNR-0066': 'Rolex',
  '126715CHNR-0065': 'Rolex',
  '126711CHNR-0067': 'Rolex',
  '126715CHNR-0066': 'Rolex',
  '126711CHNR-0068': 'Rolex',
  '126715CHNR-0067': 'Rolex',
  '126711CHNR-0069': 'Rolex',
  '126715CHNR-0068': 'Rolex',
  '126711CHNR-0070': 'Rolex',
  '126715CHNR-0069': 'Rolex',
  '126711CHNR-0071': 'Rolex',
  '126715CHNR-0070': 'Rolex',
  '126711CHNR-0072': 'Rolex',
  '126715CHNR-0071': 'Rolex',
  '126711CHNR-0073': 'Rolex',
  '126715CHNR-0072': 'Rolex',
  '126711CHNR-0074': 'Rolex',
  '126715CHNR-0073': 'Rolex',
  '126711CHNR-0075': 'Rolex',
  '126715CHNR-0074': 'Rolex',
  '126711CHNR-0076': 'Rolex',
  '126715CHNR-0075': 'Rolex',
  '126711CHNR-0077': 'Rolex',
  '126715CHNR-0076': 'Rolex',
  '126711CHNR-0078': 'Rolex',
  '126715CHNR-0077': 'Rolex',
  '126711CHNR-0079': 'Rolex',
  '126715CHNR-0078': 'Rolex',
  '126711CHNR-0080': 'Rolex',
  '126715CHNR-0079': 'Rolex',
  '126711CHNR-0081': 'Rolex',
  '126715CHNR-0080': 'Rolex',
  '126711CHNR-0082': 'Rolex',
  '126715CHNR-0081': 'Rolex',
  '126711CHNR-0083': 'Rolex',
  '126715CHNR-0082': 'Rolex',
  '126711CHNR-0084': 'Rolex',
  '126715CHNR-0083': 'Rolex',
  '126711CHNR-0085': 'Rolex',
  '126715CHNR-0084': 'Rolex',
  '126711CHNR-0086': 'Rolex',
  '126715CHNR-0085': 'Rolex',
  '126711CHNR-0087': 'Rolex',
  '126715CHNR-0086': 'Rolex',
  '126711CHNR-0088': 'Rolex',
  '126715CHNR-0087': 'Rolex',
  '126711CHNR-0089': 'Rolex',
  '126715CHNR-0088': 'Rolex',
  '126711CHNR-0090': 'Rolex',
  '126715CHNR-0089': 'Rolex',
  '126711CHNR-0091': 'Rolex',
  '126715CHNR-0090': 'Rolex',
  '126711CHNR-0092': 'Rolex',
  '126715CHNR-0091': 'Rolex',
  '126711CHNR-0093': 'Rolex',
  '126715CHNR-0092': 'Rolex',
  '126711CHNR-0094': 'Rolex',
  '126715CHNR-0093': 'Rolex',
  '126711CHNR-0095': 'Rolex',
  '126715CHNR-0094': 'Rolex',
  '126711CHNR-0096': 'Rolex',
  '126715CHNR-0095': 'Rolex',
  '126711CHNR-0097': 'Rolex',
  '126715CHNR-0096': 'Rolex',
  '126711CHNR-0098': 'Rolex',
  '126715CHNR-0097': 'Rolex',
  '126711CHNR-0099': 'Rolex',
  '126715CHNR-0098': 'Rolex',
  '126711CHNR-0100': 'Rolex',
  '126715CHNR-0099': 'Rolex',
  '126711CHNR-0101': 'Rolex',
  '126715CHNR-0100': 'Rolex',
  '126711CHNR-0102': 'Rolex',
  '126715CHNR-0101': 'Rolex',
  '126711CHNR-0103': 'Rolex',
  '126715CHNR-0102': 'Rolex',
  '126711CHNR-0104': 'Rolex',
  '126715CHNR-0103': 'Rolex',
  '126711CHNR-0105': 'Rolex',
  '126715CHNR-0104': 'Rolex',
  '126711CHNR-0106': 'Rolex',
  '126715CHNR-0105': 'Rolex',
  '126711CHNR-0107': 'Rolex',
  '126715CHNR-0106': 'Rolex',
  '126711CHNR-0108': 'Rolex',
  '126715CHNR-0107': 'Rolex',
  '126711CHNR-0109': 'Rolex',
  '126715CHNR-0108': 'Rolex',
  '126711CHNR-0110': 'Rolex',
  '126715CHNR-0109': 'Rolex',
  '126711CHNR-0111': 'Rolex',
  '126715CHNR-0110': 'Rolex',
  '126711CHNR-0112': 'Rolex',
  '126715CHNR-0111': 'Rolex',
  '126711CHNR-0113': 'Rolex',
  '126715CHNR-0112': 'Rolex',
  '126711CHNR-0114': 'Rolex',
  '126715CHNR-0113': 'Rolex',
  '126711CHNR-0115': 'Rolex',
  '126715CHNR-0114': 'Rolex',
  '126711CHNR-0116': 'Rolex',
  '126715CHNR-0115': 'Rolex',
  '126711CHNR-0117': 'Rolex',
  '126715CHNR-0116': 'Rolex',
  '126711CHNR-0118': 'Rolex',
  '126715CHNR-0117': 'Rolex',
  '126711CHNR-0119': 'Rolex',
  '126715CHNR-0118': 'Rolex',
  '126711CHNR-0120': 'Rolex',
  '126715CHNR-0119': 'Rolex',
  '126711CHNR-0121': 'Rolex',
  '126715CHNR-0120': 'Rolex',
  '126711CHNR-0122': 'Rolex',
  '126715CHNR-0121': 'Rolex',
  '126711CHNR-0123': 'Rolex',
  '126715CHNR-0122': 'Rolex',
  '126711CHNR-0124': 'Rolex',
  '126715CHNR-0123': 'Rolex',
  '126711CHNR-0125': 'Rolex',
  '126715CHNR-0124': 'Rolex',
  '126711CHNR-0126': 'Rolex',
  '126715CHNR-0125': 'Rolex',
  '126711CHNR-0127': 'Rolex',
  '126715CHNR-0126': 'Rolex',
  '126711CHNR-0128': 'Rolex',
  '126715CHNR-0127': 'Rolex',
  '126711CHNR-0129': 'Rolex',
  '126715CHNR-0128': 'Rolex',
  '126711CHNR-0130': 'Rolex',
  '126715CHNR-0129': 'Rolex',
  '126711CHNR-0131': 'Rolex',
  '126715CHNR-0130': 'Rolex',
  '126711CHNR-0132': 'Rolex',
  '126715CHNR-0131': 'Rolex',
  '126711CHNR-0133': 'Rolex',
  '126715CHNR-0132': 'Rolex',
  '126711CHNR-0134': 'Rolex',
  '126715CHNR-0133': 'Rolex',
  '126711CHNR-0135': 'Rolex',
  '126715CHNR-0134': 'Rolex',
  '126711CHNR-0136': 'Rolex',
  '126715CHNR-0135': 'Rolex',
  '126711CHNR-0137': 'Rolex',
  '126715CHNR-0136': 'Rolex',
  '126711CHNR-0138': 'Rolex',
  '126715CHNR-0137': 'Rolex',
  '126711CHNR-0139': 'Rolex',
  '126715CHNR-0138': 'Rolex',
  '126711CHNR-0140': 'Rolex',
  '126715CHNR-0139': 'Rolex',
  '126711CHNR-0141': 'Rolex',
  '126715CHNR-0140': 'Rolex',
  '126711CHNR-0142': 'Rolex',
  '126715CHNR-0141': 'Rolex',
  '126711CHNR-0143': 'Rolex',
  '126715CHNR-0142': 'Rolex',
  '126711CHNR-0144': 'Rolex',
  '126715CHNR-0143': 'Rolex',
  '126711CHNR-0145': 'Rolex',
  '126715CHNR-0144': 'Rolex',
  '126711CHNR-0146': 'Rolex',
  '126715CHNR-0145': 'Rolex',
  '126711CHNR-0147': 'Rolex',
  '126715CHNR-0146': 'Rolex',
  '126711CHNR-0148': 'Rolex',
  '126715CHNR-0147': 'Rolex',
  '126711CHNR-0149': 'Rolex',
  '126715CHNR-0148': 'Rolex',
  '126711CHNR-0150': 'Rolex',
  '126715CHNR-0149': 'Rolex',
  '126711CHNR-0151': 'Rolex',
  '126715CHNR-0150': 'Rolex',
  '126711CHNR-0152': 'Rolex',
  '126715CHNR-0151': 'Rolex',
  '126711CHNR-0153': 'Rolex',
  '126715CHNR-0152': 'Rolex',
  '126711CHNR-0154': 'Rolex',
  '126715CHNR-0153': 'Rolex',
  '126711CHNR-0155': 'Rolex',
  '126715CHNR-0154': 'Rolex',
  '126711CHNR-0156': 'Rolex',
  '126715CHNR-0155': 'Rolex',
  '126711CHNR-0157': 'Rolex',
  '126715CHNR-0156': 'Rolex',
  '126711CHNR-0158': 'Rolex',
  '126715CHNR-0157': 'Rolex',
  '126711CHNR-0159': 'Rolex',
  '126715CHNR-0158': 'Rolex',
  '126711CHNR-0160': 'Rolex',
  '126715CHNR-0159': 'Rolex',
  '126711CHNR-0161': 'Rolex',
  '126715CHNR-0160': 'Rolex',
  '126711CHNR-0162': 'Rolex',
  '126715CHNR-0161': 'Rolex',
  '126711CHNR-0163': 'Rolex',
  '126715CHNR-0162': 'Rolex',
  '126711CHNR-0164': 'Rolex',
  '126715CHNR-0163': 'Rolex',
  '126711CHNR-0165': 'Rolex',
  '126715CHNR-0164': 'Rolex',
  '126711CHNR-0166': 'Rolex',
  '126715CHNR-0165': 'Rolex',
  '126711CHNR-0167': 'Rolex',
  '126715CHNR-0166': 'Rolex',
  '126711CHNR-0168': 'Rolex',
  '126715CHNR-0167': 'Rolex',
  '126711CHNR-0169': 'Rolex',
  '126715CHNR-0168': 'Rolex',
  '126711CHNR-0170': 'Rolex',
  '126715CHNR-0169': 'Rolex',
  '126711CHNR-0171': 'Rolex',
  '126715CHNR-0170': 'Rolex',
  '126711CHNR-0172': 'Rolex',
  '126715CHNR-0171': 'Rolex',
  '126711CHNR-0173': 'Rolex',
  '126715CHNR-0172': 'Rolex',
  '126711CHNR-0174': 'Rolex',
  '126715CHNR-0173': 'Rolex',
  '126711CHNR-0175': 'Rolex',
  '126715CHNR-0174': 'Rolex',
  '126711CHNR-0176': 'Rolex',
  '126715CHNR-0175': 'Rolex',
  '126711CHNR-0177': 'Rolex',
  '126715CHNR-0176': 'Rolex',
  '126711CHNR-0178': 'Rolex',
  '126715CHNR-0177': 'Rolex',
  '126711CHNR-0179': 'Rolex',
  '126715CHNR-0178': 'Rolex',
  '126711CHNR-0180': 'Rolex',
  '126715CHNR-0179': 'Rolex',
  '126711CHNR-0181': 'Rolex',
  '126715CHNR-0180': 'Rolex',
  '126711CHNR-0182': 'Rolex',
  '126715CHNR-0181': 'Rolex',
  '126711CHNR-0183': 'Rolex',
  '126715CHNR-0182': 'Rolex',
  '126711CHNR-0184': 'Rolex',
  '126715CHNR-0183': 'Rolex',
  '126711CHNR-0185': 'Rolex',
  '126715CHNR-0184': 'Rolex',
  '126711CHNR-0186': 'Rolex',
  '126715CHNR-0185': 'Rolex',
  '126711CHNR-0187': 'Rolex',
  '126715CHNR-0186': 'Rolex',
  '126711CHNR-0188': 'Rolex',
  '126715CHNR-0187': 'Rolex',
  '126711CHNR-0189': 'Rolex',
  '126715CHNR-0188': 'Rolex',
  '126711CHNR-0190': 'Rolex',
  '126715CHNR-0189': 'Rolex',
  '126711CHNR-0191': 'Rolex',
  '126715CHNR-0190': 'Rolex',
  '126711CHNR-0192': 'Rolex',
  '126715CHNR-0191': 'Rolex',
  '126711CHNR-0193': 'Rolex',
  '126715CHNR-0192': 'Rolex',
  '126711CHNR-0194': 'Rolex',
  '126715CHNR-0193': 'Rolex',
  '126711CHNR-0195': 'Rolex',
  '126715CHNR-0194': 'Rolex',
  '126711CHNR-0196': 'Rolex',
  '126715CHNR-0195': 'Rolex',
  '126711CHNR-0197': 'Rolex',
  '126715CHNR-0196': 'Rolex',
  '126711CHNR-0198': 'Rolex',
  '126715CHNR-0197': 'Rolex',
  '126711CHNR-0199': 'Rolex',
  '126715CHNR-0198': 'Rolex',
  '126711CHNR-0200': 'Rolex',
  '126715CHNR-0199': 'Rolex',
  '126711CHNR-0201': 'Rolex',
  '126715CHNR-0200': 'Rolex',
  '126711CHNR-0202': 'Rolex',
  '126715CHNR-0201': 'Rolex',
  '126711CHNR-0203': 'Rolex',
  '126715CHNR-0202': 'Rolex',
  '126711CHNR-0204': 'Rolex',
  '126715CHNR-0203': 'Rolex',
  '126711CHNR-0205': 'Rolex',
  '126715CHNR-0204': 'Rolex',
  '126711CHNR-0206': 'Rolex',
  '126715CHNR-0205': 'Rolex',
  '126711CHNR-0207': 'Rolex',
  '126715CHNR-0206': 'Rolex',
  '126711CHNR-0208': 'Rolex',
  '126715CHNR-0207': 'Rolex',
  '126711CHNR-0209': 'Rolex',
  '126715CHNR-0208': 'Rolex',
  '126711CHNR-0210': 'Rolex',
  '126715CHNR-0209': 'Rolex',
  '126711CHNR-0211': 'Rolex',
  '126715CHNR-0210': 'Rolex',
  '126711CHNR-0212': 'Rolex',
  '126715CHNR-0211': 'Rolex',
  '126711CHNR-0213': 'Rolex',
  '126715CHNR-0212': 'Rolex',
  '126711CHNR-0214': 'Rolex',
  '126715CHNR-0213': 'Rolex',
  '126711CHNR-0215': 'Rolex',
  '126715CHNR-0214': 'Rolex',
  '126711CHNR-0216': 'Rolex',
  '126715CHNR-0215': 'Rolex',
  '126711CHNR-0217': 'Rolex',
  '126715CHNR-0216': 'Rolex',
  '126711CHNR-0218': 'Rolex',
  '126715CHNR-0217': 'Rolex',
  '126711CHNR-0219': 'Rolex',
  '126715CHNR-0218': 'Rolex',
  '126711CHNR-0220': 'Rolex',
  '126715CHNR-0219': 'Rolex',
  '126711CHNR-0221': 'Rolex',
  '126715CHNR-0220': 'Rolex',
  '126711CHNR-0222': 'Rolex',
  '126715CHNR-0221': 'Rolex',
  '126711CHNR-0223': 'Rolex',
  '126715CHNR-0222': 'Rolex',
  '126711CHNR-0224': 'Rolex',
  '126715CHNR-0223': 'Rolex',
  '126711CHNR-0225': 'Rolex',
  '126715CHNR-0224': 'Rolex',
  '126711CHNR-0226': 'Rolex',
  '126715CHNR-0225': 'Rolex',
  '126711CHNR-0227': 'Rolex',
  '126715CHNR-0226': 'Rolex',
  '126711CHNR-0228': 'Rolex',
  '126715CHNR-0227': 'Rolex',
  '126711CHNR-0229': 'Rolex',
  '126715CHNR-0228': 'Rolex',
  '126711CHNR-0230': 'Rolex',
  '126715CHNR-0229': 'Rolex',
  '126711CHNR-0231': 'Rolex',
  '126715CHNR-0230': 'Rolex',
  '126711CHNR-0232': 'Rolex',
  '126715CHNR-0231': 'Rolex',
  '126711CHNR-0233': 'Rolex',
  '126715CHNR-0232': 'Rolex',
  '126711CHNR-0234': 'Rolex',
  '126715CHNR-0233': 'Rolex',
  '126711CHNR-0235': 'Rolex',
  '126715CHNR-0234': 'Rolex',
  '126711CHNR-0236': 'Rolex',
  '126715CHNR-0235': 'Rolex',
  '126711CHNR-0237': 'Rolex',
  '126715CHNR-0236': 'Rolex',
  '126711CHNR-0238': 'Rolex',
  '126715CHNR-0237': 'Rolex',
  '126711CHNR-0239': 'Rolex',
  '126715CHNR-0238': 'Rolex',
  '126711CHNR-0240': 'Rolex',
  '126715CHNR-0239': 'Rolex',
  '126711CHNR-0241': 'Rolex',
  '126715CHNR-0240': 'Rolex',
  '126711CHNR-0242': 'Rolex',
  '126715CHNR-0241': 'Rolex',
  '126711CHNR-0243': 'Rolex',
  '126715CHNR-0242': 'Rolex',
  '126711CHNR-0244': 'Rolex',
  '126715CHNR-0243': 'Rolex',
  '126711CHNR-0245': 'Rolex',
  '126715CHNR-0244': 'Rolex',
  '126711CHNR-0246': 'Rolex',
  '126715CHNR-0245': 'Rolex',
  '126711CHNR-0247': 'Rolex',
  '126715CHNR-0246': 'Rolex',
  '126711CHNR-0248': 'Rolex',
  '126715CHNR-0247': 'Rolex',
  '126711CHNR-0249': 'Rolex',
  '126715CHNR-0248': 'Rolex',
  '126711CHNR-0250': 'Rolex',
  '126715CHNR-0249': 'Rolex',
  '126711CHNR-0251': 'Rolex',
  '126715CHNR-0250': 'Rolex',
  '126711CHNR-0252': 'Rolex',
  '126715CHNR-0251': 'Rolex',
  '126711CHNR-0253': 'Rolex',
  '126715CHNR-0252': 'Rolex',
  '126711CHNR-0254': 'Rolex',
  '126715CHNR-0253': 'Rolex',
  '126711CHNR-0255': 'Rolex',
  '126715CHNR-0254': 'Rolex',
  '126711CHNR-0256': 'Rolex',
  '126715CHNR-0255': 'Rolex',
  '126711CHNR-0257': 'Rolex',
  '126715CHNR-0256': 'Rolex',
  '126711CHNR-0258': 'Rolex',
  '126715CHNR-0257': 'Rolex',
  '126711CHNR-0259': 'Rolex',
  '126715CHNR-0258': 'Rolex',
  '126711CHNR-0260': 'Rolex',
  '126715CHNR-0259': 'Rolex',
  '126711CHNR-0261': 'Rolex',
  '126715CHNR-0260': 'Rolex',
  '126711CHNR-0262': 'Rolex',
  '126715CHNR-0261': 'Rolex',
  '126711CHNR-0263': 'Rolex',
  '126715CHNR-0262': 'Rolex',
  '126711CHNR-0264': 'Rolex',
  '126715CHNR-0263': 'Rolex',
  '126711CHNR-0265': 'Rolex',
  '126715CHNR-0264': 'Rolex',
  '126711CHNR-0266': 'Rolex',
  '126715CHNR-0265': 'Rolex',
  '126711CHNR-0267': 'Rolex',
  '126715CHNR-0266': 'Rolex',
  '126711CHNR-0268': 'Rolex',
  '126715CHNR-0267': 'Rolex',
  '126711CHNR-0269': 'Rolex',
  '126715CHNR-0268': 'Rolex',
  '126711CHNR-0270': 'Rolex',
  '126715CHNR-0269': 'Rolex',
  '126711CHNR-0271': 'Rolex',
  '126715CHNR-0270': 'Rolex',
  '126711CHNR-0272': 'Rolex',
  '126715CHNR-0271': 'Rolex',
  '126711CHNR-0273': 'Rolex',
  '126715CHNR-0272': 'Rolex',
  '126711CHNR-0274': 'Rolex',
  '126715CHNR-0273': 'Rolex',
  '126711CHNR-0275': 'Rolex',
  '126715CHNR-0274': 'Rolex',
  '126711CHNR-0276': 'Rolex',
  '126715CHNR-0275': 'Rolex',
  '126711CHNR-0277': 'Rolex',
  '126715CHNR-0276': 'Rolex',
  '126711CHNR-0278': 'Rolex',
  '126715CHNR-0277': 'Rolex',
  '126711CHNR-0279': 'Rolex',
  '126715CHNR-0278': 'Rolex',
  '126711CHNR-0280': 'Rolex',
  '126715CHNR-0279': 'Rolex',
  '126711CHNR-0281': 'Rolex',
  '126715CHNR-0280': 'Rolex',
  '126711CHNR-0282': 'Rolex',
  '126715CHNR-0281': 'Rolex',
  '126711CHNR-0283': 'Rolex',
  '126715CHNR-0282': 'Rolex',
  '126711CHNR-0284': 'Rolex',
  '126715CHNR-0283': 'Rolex',
  '126711CHNR-0285': 'Rolex',
  '126715CHNR-0284': 'Rolex',
  '126711CHNR-0286': 'Rolex',
  '126715CHNR-0285': 'Rolex',
  '126711CHNR-0287': 'Rolex',
  '126715CHNR-0286': 'Rolex',
  '126711CHNR-0288': 'Rolex',
  '126715CHNR-0287': 'Rolex',
  '126711CHNR-0289': 'Rolex',
  '126715CHNR-0288': 'Rolex',
  '126711CHNR-0290': 'Rolex',
  '126715CHNR-0289': 'Rolex',
  '126711CHNR-0291': 'Rolex',
  '126715CHNR-0290': 'Rolex',
  '126711CHNR-0292': 'Rolex',
  '126715CHNR-0291': 'Rolex',
  '126711CHNR-0293': 'Rolex',
  '126715CHNR-0292': 'Rolex',
  '126711CHNR-0294': 'Rolex',
  '126715CHNR-0293': 'Rolex',
  '126711CHNR-0295': 'Rolex',
  '126715CHNR-0294': 'Rolex',
  '126711CHNR-0296': 'Rolex',
  '126715CHNR-0295': 'Rolex',
  '126711CHNR-0297': 'Rolex',
  '126715CHNR-0296': 'Rolex',
  '126711CHNR-0298': 'Rolex',
  '126715CHNR-0297': 'Rolex',
  '126711CHNR-0299': 'Rolex',
  '126715CHNR-0298': 'Rolex',
  '126711CHNR-0300': 'Rolex',
  '126715CHNR-0299': 'Rolex',
  '126711CHNR-0301': 'Rolex',
  '126715CHNR-0300': 'Rolex',
  '126711CHNR-0302': 'Rolex',
  '126715CHNR-0301': 'Rolex',
  '126711CHNR-0303': 'Rolex',
  '126715CHNR-0302': 'Rolex',
  '126711CHNR-0304': 'Rolex',
  '126715CHNR-0303': 'Rolex',
  '126711CHNR-0305': 'Rolex',
  '126715CHNR-0304': 'Rolex',
  '126711CHNR-0306': 'Rolex',
  '126715CHNR-0305': 'Rolex',
  '126711CHNR-0307': 'Rolex',
  '126715CHNR-0306': 'Rolex',
  '126711CHNR-0308': 'Rolex',
  '126715CHNR-0307': 'Rolex',
  '126711CHNR-0309': 'Rolex',
  '126715CHNR-0308': 'Rolex',
  '126711CHNR-0310': 'Rolex',
  '126715CHNR-0309': 'Rolex',
  '126711CHNR-0311': 'Rolex',
  '126715CHNR-0310': 'Rolex',
  '126711CHNR-0312': 'Rolex',
  '126715CHNR-0311': 'Rolex',
  '126711CHNR-0313': 'Rolex',
  '126715CHNR-0312': 'Rolex',
  '126711CHNR-0314': 'Rolex',
  '126715CHNR-0313': 'Rolex',
  '126711CHNR-0315': 'Rolex',
  '126715CHNR-0314': 'Rolex',
  '126711CHNR-0316': 'Rolex',
  '126715CHNR-0315': 'Rolex',
  '126711CHNR-0317': 'Rolex',
  '126715CHNR-0316': 'Rolex',
  '126711CHNR-0318': 'Rolex',
  '126715CHNR-0317': 'Rolex',
  '126711CHNR-0319': 'Rolex',
  '126715CHNR-0318': 'Rolex',
  '126711CHNR-0320': 'Rolex',
  '126715CHNR-0319': 'Rolex',
  '126711CHNR-0321': 'Rolex',
  '126715CHNR-0320': 'Rolex',
  '126711CHNR-0322': 'Rolex',
  '126715CHNR-0321': 'Rolex',
  '126711CHNR-0323': 'Rolex',
  '126715CHNR-0322': 'Rolex',
  '126711CHNR-0324': 'Rolex',
  '126715CHNR-0323': 'Rolex',
  '126711CHNR-0325': 'Rolex',
  '126715CHNR-0324': 'Rolex',
  '126711CHNR-0326': 'Rolex',
  '126715CHNR-0325': 'Rolex',
  '126711CHNR-0327': 'Rolex',
  '126715CHNR-0326': 'Rolex',
  '126711CHNR-0328': 'Rolex',
  '126715CHNR-0327': 'Rolex',
  '126711CHNR-0329': 'Rolex',
  '126715CHNR-0328': 'Rolex',
  '126711CHNR-0330': 'Rolex',
  '126715CHNR-0329': 'Rolex',
  '126711CHNR-0331': 'Rolex',
  '126715CHNR-0330': 'Rolex',
  '126711CHNR-0332': 'Rolex',
  '126715CHNR-0331': 'Rolex',
  '126711CHNR-0333': 'Rolex',
  '126715CHNR-0332': 'Rolex',
  '126711CHNR-0334': 'Rolex',
  '126715CHNR-0333': 'Rolex',
  '126711CHNR-0335': 'Rolex',
  '126715CHNR-0334': 'Rolex',
  '126711CHNR-0336': 'Rolex',
  '126715CHNR-0335': 'Rolex',
  '126711CHNR-0337': 'Rolex',
  '126715CHNR-0336': 'Rolex',
};

interface ParsedWatch {
  brand?: string;
  ref?: string;
  model?: string;
  watch_year?: number;
  product_type?: string;
  set_type?: string;
  selling_price?: number;
  currency?: string;
  notes?: string;
}

function mapBrandIfMissing(watch: ParsedWatch) {
  if (!watch.brand && watch.ref) {
    // Try exact match
    let refKey = watch.ref.trim();
    if (REFERENCE_BRAND_MAPPING[refKey]) {
      watch.brand = REFERENCE_BRAND_MAPPING[refKey];
      return watch;
    }
    // Try uppercase match
    refKey = refKey.toUpperCase();
    if (REFERENCE_BRAND_MAPPING[refKey]) {
      watch.brand = REFERENCE_BRAND_MAPPING[refKey];
      return watch;
    }
    // Try removing spaces and dashes
    refKey = refKey.replace(/[-\s]/g, '');
    if (REFERENCE_BRAND_MAPPING[refKey]) {
      watch.brand = REFERENCE_BRAND_MAPPING[refKey];
      return watch;
    }
  }
  // If still missing, leave as is (admin will select later)
  return watch;
}

export async function POST(request: Request) {
  const apiKey = process.env.GEMINI_API_KEY;

  if (!apiKey) {
    console.error("Gemini API Key is not found in environment variables.");
    return NextResponse.json({ error: "Server configuration error: Gemini API Key is missing." }, { status: 500 });
  }

  try {
    const body = await request.json();
    const { text } = body;

    if (!text || typeof text !== 'string' || text.length < 10) {
      return NextResponse.json({ error: 'Valid text input is required.' }, { status: 400 });
    }

    const prompt = `
      You are a specialized watch listing parser. Your single task is to analyze the following text and extract information for one or more watches.
      You MUST respond with ONLY a valid JSON array where each object represents a single watch.
      For each watch object, use the following fields: 
      - brand: (string), model: (string), ref: (string), watch_year: (number), 
      - product_type: (string from 'New', 'Used', 'Vintage', 'NOS'), 
      - set_type: (string from 'Full Set', 'Watch only'), 
      - selling_price: (number), currency: (string), notes: (string). 
      Rules: 
      - If info is missing, use null. If no watches are found, return an empty array []. 
      - Deduce 'set_type' from 'กล่องใบครบ' (Full Set) or 'มีแต่ตัวเรือน' (Watch only). 
      - Deduce 'product_type' from 'Unworn' (New) or the year (Vintage if before 1990).
      - Do not add explanations or markdown formatting.

      Text to analyze: 
      --- 
      ${text} 
      --- 
    `;

    const payload = {
      contents: [{ role: "user", parts: [{ text: prompt }] }],
      generationConfig: {
        response_mime_type: "application/json",
        temperature: 0.1,
        maxOutputTokens: 8192,
      },
    };

    const modelName = 'gemini-2.0-flash';
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
    
    console.log(`Calling Gemini model: ${modelName}`);

    const aiResponse = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const responseText = await aiResponse.text();
    
    if (!aiResponse.ok) {
        console.error("Gemini API Error:", responseText);
        return new Response(JSON.stringify({ error: `AI service failed with status ${aiResponse.status}`, details: responseText }), {
            status: aiResponse.status,
            headers: { 'Content-Type': 'application/json' }
        });
    }

    try {
        const aiResult = JSON.parse(responseText);
        const generatedText = aiResult.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (!generatedText) {
          throw new Error("AI response is empty or has an invalid structure.");
        }

        const finalData = JSON.parse(generatedText);
        // Map brand if missing
        const watches = (finalData.watches || finalData || []).map(mapBrandIfMissing);
        return NextResponse.json(watches);
        
    } catch(parseError) {
        console.error("JSON Parse Error:", parseError);
        console.error("Raw response that failed to parse:", responseText);
        return NextResponse.json({ error: "Failed to parse AI response as JSON.", details: responseText }, { status: 500 });
    }

  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : "An unknown error occurred";
    return NextResponse.json({ error: "An internal server error occurred.", details: errorMessage }, { status: 500 });
  }
}